name: Check for Runtime Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9am UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get supported Lambda Node.js versions
        id: nodejs
        run: |
          # Get versions from AWS docs, filter to supported (18+)
          VERSIONS=$(curl -s "https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html" | \
            grep -oP 'nodejs\d+\.x' | grep -oP '\d+' | sort -n | uniq | \
            awk '$1 >= 18' | tr '\n' ',' | sed 's/,$//')
          [ -z "$VERSIONS" ] && VERSIONS="18,20,22"
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

          # Convert to JSON array for matrix
          JSON_ARRAY=$(echo "$VERSIONS" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          echo "json_array=$JSON_ARRAY" >> $GITHUB_OUTPUT

      - name: Get latest mssql npm version
        id: mssql
        run: |
          LATEST=$(npm view mssql version)
          [ -z "$LATEST" ] && LATEST="12.0.0"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Get current versions
        id: current
        run: |
          # Extract current Node.js versions from versions.json
          NODE_VERSIONS=$(cat versions.json | jq -r '.node_versions | join(",")')
          MSSQL=$(grep -oP '"mssql": "\^\K[^"]+' package.json || echo "12.0.0")
          echo "node=$NODE_VERSIONS" >> $GITHUB_OUTPUT
          echo "mssql=$MSSQL" >> $GITHUB_OUTPUT

      - name: Determine updates needed
        id: update
        run: |
          NEW_NODE="${{ steps.nodejs.outputs.versions }}"
          NEW_MSSQL="${{ steps.mssql.outputs.version }}"
          CURRENT_NODE="${{ steps.current.outputs.node }}"
          CURRENT_MSSQL="${{ steps.current.outputs.mssql }}"

          # Check if mssql major version changed
          NEW_MSSQL_MAJOR=$(echo $NEW_MSSQL | cut -d. -f1)
          CURRENT_MSSQL_MAJOR=$(echo $CURRENT_MSSQL | cut -d. -f1)

          NEEDS_UPDATE=false
          MSSQL_CHANGED=false
          NODE_CHANGED=false

          # Detect mssql major version change
          if [ "$NEW_MSSQL_MAJOR" != "$CURRENT_MSSQL_MAJOR" ]; then
            NEEDS_UPDATE=true
            MSSQL_CHANGED=true
          fi

          # Detect Node.js version change
          if [ "$NEW_NODE" != "$CURRENT_NODE" ]; then
            NEEDS_UPDATE=true
            NODE_CHANGED=true
          fi

          echo "node_versions=$NEW_NODE" >> $GITHUB_OUTPUT
          echo "node_json=${{ steps.nodejs.outputs.json_array }}" >> $GITHUB_OUTPUT
          echo "mssql_new=$NEW_MSSQL" >> $GITHUB_OUTPUT
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "mssql_changed=$MSSQL_CHANGED" >> $GITHUB_OUTPUT
          echo "node_changed=$NODE_CHANGED" >> $GITHUB_OUTPUT

      - name: Update package.json
        if: steps.update.outputs.mssql_changed == 'true'
        run: |
          MSSQL="${{ steps.update.outputs.mssql_new }}"
          MAJOR=$(echo $MSSQL | cut -d. -f1)
          sed -i "s/\"mssql\": \"\\^[^\"]*\"/\"mssql\": \"^$MAJOR.0.0\"/" package.json
          npm install --package-lock-only

      - name: Update versions.json
        if: steps.update.outputs.node_changed == 'true'
        run: |
          NODE_JSON="${{ steps.update.outputs.node_json }}"
          # Update versions.json with new Node.js versions
          echo "{\"node_versions\": $NODE_JSON}" | jq '.' > versions.json

      - name: Create PR for updates
        if: steps.update.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="chore/update-runtimes-$(date +%Y%m%d)"

          # Check if a PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH, skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Build commit message and PR body based on what changed
          CHANGES=""
          FILES_TO_ADD=""

          if [ "${{ steps.update.outputs.node_changed }}" == "true" ]; then
            CHANGES="${CHANGES}- Node.js Lambda runtimes: ${{ steps.update.outputs.node_versions }}\n"
            FILES_TO_ADD="${FILES_TO_ADD} versions.json"
          fi

          if [ "${{ steps.update.outputs.mssql_changed }}" == "true" ]; then
            CHANGES="${CHANGES}- mssql package: ${{ steps.update.outputs.mssql_new }}\n"
            FILES_TO_ADD="${FILES_TO_ADD} package.json package-lock.json"
          fi

          # Delete existing remote branch if it exists (stale from failed run)
          git push origin --delete "$BRANCH" 2>/dev/null || true

          git checkout -b "$BRANCH"
          git add $FILES_TO_ADD
          git commit -m "chore: update Lambda runtimes

          $(echo -e "$CHANGES")"

          git push origin "$BRANCH"

          gh pr create \
            --title "chore: update Lambda runtimes" \
            --body "## Summary
          $(echo -e "$CHANGES")
          This PR was automatically generated by the Check for Runtime Updates workflow." \
            --base main \
            --head "$BRANCH"
